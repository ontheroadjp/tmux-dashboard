#!/bin/bash
set -euo pipefail

REPO_ROOT="__REPO_ROOT__"
BACKEND_DIR="$REPO_ROOT/backend"
ENV_FILE="$BACKEND_DIR/.env.prod"

if [ -f "$ENV_FILE" ]; then
  set -a
  source "$ENV_FILE"
  set +a
fi

: "${DASHBOARD_AUTH_USER:?DASHBOARD_AUTH_USER is required. Set it in backend/.env.prod}"
: "${DASHBOARD_AUTH_PASSWORD:?DASHBOARD_AUTH_PASSWORD is required. Set it in backend/.env.prod}"
: "${DASHBOARD_AUTH_SECRET:?DASHBOARD_AUTH_SECRET is required in production}"
export DASHBOARD_ENV=prod
export DASHBOARD_ENV_FILE="$ENV_FILE"

if [ ! -x "$BACKEND_DIR/venv/bin/gunicorn" ]; then
  echo "gunicorn not found at $BACKEND_DIR/venv/bin/gunicorn. Run: cd backend && ./venv/bin/pip install -r requirements.txt" >&2
  exit 1
fi

cd "$BACKEND_DIR"
exec ./venv/bin/gunicorn \
  --workers "${GUNICORN_WORKERS:-2}" \
  --bind 127.0.0.1:10323 \
  --access-logfile - \
  --error-logfile - \
  "tmux_dashboard:create_app()"

#!/bin/bash
set -euo pipefail

REPO_ROOT="__REPO_ROOT__"
FRONTEND_DIR="$REPO_ROOT/frontend"
ENV_FILE="$FRONTEND_DIR/.env.prod"
NVM_NODE_GLOB="$HOME/.nvm/versions/node"/*/bin

if [ -f "$ENV_FILE" ]; then
  set -a
  source "$ENV_FILE"
  set +a
fi

if ! command -v node >/dev/null 2>&1; then
  for bin_dir in $NVM_NODE_GLOB; do
    if [ -x "$bin_dir/node" ]; then
      export PATH="$bin_dir:$PATH"
    fi
  done
fi

if ! command -v node >/dev/null 2>&1; then
  echo "node not found. Install Node.js or set PATH in launchd." >&2
  exit 1
fi

if [ ! -f "$FRONTEND_DIR/.next/BUILD_ID" ]; then
  echo "frontend build is missing. Run: cd frontend && npm run build" >&2
  exit 1
fi

cd "$FRONTEND_DIR"
exec ./node_modules/.bin/next start -H 127.0.0.1 -p 10322
